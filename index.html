<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>BlueLog Overview</title>
<style>
:root {
  --primary: #3b82f6;
  --primary-dark: #2563eb;
  --primary-light: #60a5fa;
  --surface: #1e293b;
  --background: #0f172a;
  --border: #334155;
  --text-primary: #f1f5f9;
  --text-secondary: #94a3b8;
  --hover: #293548;
  --shadow: 0 1px 3px 0 rgb(0 0 0 / 0.3), 0 1px 2px -1px rgb(0 0 0 / 0.3);
  --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.3), 0 4px 6px -4px rgb(0 0 0 / 0.3);
  --input-bg: #0f172a;
  --input-border: #475569;
}

* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

body {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
  background: var(--background);
  color: var(--text-primary);
  line-height: 1.6;
  padding: 2rem 1rem;
}

.header {
  max-width: 1400px;
  margin: 0 auto 1.5rem;
  display: flex;
  justify-content: space-between;
  align-items: center;
  flex-wrap: wrap;
  gap: 1rem;
}

h2 {
  font-size: 1.875rem;
  font-weight: 700;
  color: var(--text-primary);
  letter-spacing: -0.025em;
}

.stats {
  display: flex;
  gap: 1.5rem;
  font-size: 0.875rem;
  color: var(--text-secondary);
}

.stat-item {
  display: flex;
  flex-direction: column;
  gap: 0.25rem;
  cursor: pointer;
  padding: 0.5rem 0.75rem;
  border-radius: 8px;
  transition: all 0.2s ease;
  border: 1px solid transparent;
}

.stat-item:hover {
  background: var(--hover);
  transform: translateY(-2px);
  border-color: var(--border);
}

.stat-item.active {
  background: var(--primary);
  color: white;
  border-color: var(--primary);
}

.stat-item.active .stat-label,
.stat-item.active .stat-value {
  color: white;
}

.stat-label {
  font-weight: 500;
  text-transform: uppercase;
  font-size: 0.75rem;
  letter-spacing: 0.05em;
}

.stat-value {
  font-size: 1.25rem;
  font-weight: 600;
  color: var(--primary);
  transition: color 0.2s ease;
}

.search-container {
  max-width: 1400px;
  margin: 0 auto 1.5rem;
  position: relative;
}

.search-wrapper {
  position: relative;
  display: flex;
  align-items: center;
}

.search-icon {
  position: absolute;
  left: 1rem;
  color: var(--text-secondary);
  pointer-events: none;
  font-size: 1.125rem;
}

#searchInput {
  width: 100%;
  padding: 0.875rem 3rem 0.875rem 3rem;
  background: var(--input-bg);
  border: 2px solid var(--input-border);
  border-radius: 12px;
  color: var(--text-primary);
  font-size: 0.938rem;
  transition: all 0.2s ease;
  outline: none;
  font-family: inherit;
}

#searchInput::placeholder {
  color: var(--text-secondary);
}

#searchInput:focus {
  border-color: var(--primary);
  box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
}

.clear-search {
  position: absolute;
  right: 1rem;
  background: transparent;
  border: none;
  color: var(--text-secondary);
  cursor: pointer;
  font-size: 1.25rem;
  padding: 0.25rem;
  display: none;
  transition: color 0.2s ease;
}

.clear-search:hover {
  color: var(--text-primary);
}

.clear-search.visible {
  display: block;
}

.container {
  max-width: 1400px;
  margin: 0 auto;
  background: var(--surface);
  border-radius: 12px;
  box-shadow: var(--shadow-lg);
  overflow: hidden;
  position: relative;
  border: 1px solid var(--border);
}

.scroll-hint {
  position: absolute;
  top: 50%;
  right: 0;
  transform: translateY(-50%);
  background: linear-gradient(to left, rgba(30, 41, 59, 0.95), transparent);
  padding: 1rem 0.5rem 1rem 2rem;
  pointer-events: none;
  z-index: 5;
  transition: opacity 0.3s ease;
  display: flex;
  align-items: center;
  gap: 0.5rem;
  color: var(--text-secondary);
  font-size: 0.875rem;
  font-weight: 500;
}

.scroll-hint.hidden {
  opacity: 0;
}

.scroll-arrow {
  animation: slideRight 1.5s ease-in-out infinite;
}

@keyframes slideRight {
  0%, 100% { transform: translateX(0); }
  50% { transform: translateX(8px); }
}

.table-wrapper {
  overflow-x: auto;
  overflow-y: visible;
  cursor: grab;
  user-select: none;
  scroll-behavior: smooth;
  scrollbar-width: thin;
  scrollbar-color: var(--primary) var(--border);
}

.table-wrapper:active {
  cursor: grabbing;
}

.table-wrapper::-webkit-scrollbar {
  height: 12px;
}

.table-wrapper::-webkit-scrollbar-track {
  background: var(--background);
  border-radius: 6px;
}

.table-wrapper::-webkit-scrollbar-thumb {
  background: var(--primary);
  border-radius: 6px;
  border: 2px solid var(--background);
}

.table-wrapper::-webkit-scrollbar-thumb:hover {
  background: var(--primary-light);
}

table {
  width: 100%;
  border-collapse: collapse;
  font-size: 0.875rem;
}

thead {
  background: linear-gradient(to bottom, #1e293b, #172033);
  position: sticky;
  top: 0;
  z-index: 10;
}

th {
  padding: 1rem;
  text-align: left;
  font-weight: 600;
  color: var(--text-primary);
  text-transform: uppercase;
  font-size: 0.75rem;
  letter-spacing: 0.05em;
  border-bottom: 2px solid var(--border);
  white-space: nowrap;
}

td {
  padding: 1rem;
  border-bottom: 1px solid var(--border);
  color: var(--text-primary);
  vertical-align: top;
}

tbody tr {
  transition: background-color 0.15s ease;
}

tbody tr:hover {
  background: var(--hover);
}

tbody tr.hidden {
  display: none;
}

tbody tr.highlight {
  background: rgba(59, 130, 246, 0.1);
  border-left: 3px solid var(--primary);
}

.badge {
  display: inline-block;
  padding: 0.25rem 0.625rem;
  background: rgba(59, 130, 246, 0.2);
  color: var(--primary-light);
  border-radius: 6px;
  font-size: 0.75rem;
  font-weight: 500;
  margin: 0.125rem;
  cursor: pointer;
  transition: all 0.2s ease;
  position: relative;
  user-select: text;
  border: 1px solid rgba(59, 130, 246, 0.3);
}

.badge:hover {
  background: var(--primary);
  color: white;
  transform: translateY(-1px);
  border-color: var(--primary);
}

.badge:active {
  transform: translateY(0);
}

.present-indicator {
  display: inline-flex;
  align-items: center;
  gap: 0.5rem;
  font-weight: 500;
}

.present-indicator::before {
  content: '';
  width: 8px;
  height: 8px;
  border-radius: 50%;
  display: inline-block;
}

.present-true::before {
  background: #22c55e;
  box-shadow: 0 0 0 3px rgba(34, 197, 94, 0.2);
}

.present-false::before {
  background: #64748b;
}

.mono {
  font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
  font-size: 0.813rem;
  color: var(--text-secondary);
}

.collapsible-content {
  cursor: pointer;
  user-select: none;
}

.collapsible-content:hover .expand-button {
  background: var(--primary);
  color: white;
  border-color: var(--primary);
}

.address-preview {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  flex-wrap: wrap;
}

.expand-button {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  padding: 0.25rem 0.5rem;
  background: var(--background);
  color: var(--text-secondary);
  border-radius: 4px;
  font-size: 0.75rem;
  font-weight: 600;
  transition: all 0.2s ease;
  min-width: 60px;
  border: 1px solid var(--border);
}

.expand-button:hover {
  transform: translateY(-1px);
}

.address-list {
  display: flex;
  flex-direction: column;
  gap: 0.25rem;
  margin-top: 0.5rem;
}

.address-item {
  font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
  font-size: 0.813rem;
  color: var(--text-secondary);
  padding: 0.25rem 0.5rem;
  background: var(--background);
  border-radius: 4px;
  cursor: pointer;
  transition: all 0.2s ease;
  position: relative;
  user-select: text;
  border: 1px solid var(--border);
}

.address-item:hover {
  background: var(--primary);
  color: white;
  transform: translateX(2px);
  border-color: var(--primary);
}

.copyable-address {
  font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
  font-size: 0.813rem;
  color: var(--text-secondary);
  cursor: pointer;
  transition: all 0.2s ease;
  padding: 0.125rem 0.25rem;
  border-radius: 3px;
  user-select: text;
}

.copyable-address:hover {
  background: var(--primary);
  color: white;
}

.collapsed .address-list,
.collapsed .presence-details,
.collapsed .presence-by-day {
  display: none;
}

.collapsed .expand-button::after {
  content: ' ‚ñº';
  margin-left: 0.25rem;
}

.expanded .expand-button::after {
  content: ' ‚ñ≤';
  margin-left: 0.25rem;
}

.info-grid {
  display: grid;
  grid-template-columns: auto 1fr;
  gap: 0.5rem 1rem;
  margin-top: 0.5rem;
  font-size: 0.813rem;
}

.info-label {
  color: var(--text-secondary);
  font-weight: 500;
}

.info-value {
  color: var(--text-primary);
  font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
}

.presence-by-day {
  margin-top: 0.5rem;
  max-height: 200px;
  overflow-y: auto;
  scrollbar-width: thin;
  scrollbar-color: var(--primary) var(--border);
}

.presence-by-day::-webkit-scrollbar {
  width: 6px;
}

.presence-by-day::-webkit-scrollbar-track {
  background: var(--background);
  border-radius: 3px;
}

.presence-by-day::-webkit-scrollbar-thumb {
  background: var(--primary);
  border-radius: 3px;
}

.day-item {
  display: flex;
  justify-content: space-between;
  padding: 0.25rem 0.5rem;
  background: var(--background);
  border-radius: 4px;
  margin-bottom: 0.25rem;
  font-size: 0.75rem;
  border: 1px solid var(--border);
}

.day-date {
  color: var(--text-secondary);
  font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
}

.day-duration {
  color: var(--primary-light);
  font-weight: 600;
}

.copy-tooltip {
  position: fixed;
  background: var(--text-primary);
  color: var(--background);
  padding: 0.5rem 0.75rem;
  border-radius: 6px;
  font-size: 0.75rem;
  font-weight: 500;
  pointer-events: none;
  z-index: 1000;
  animation: fadeInOut 1.5s ease-in-out;
  box-shadow: var(--shadow-lg);
}

@keyframes fadeInOut {
  0% { opacity: 0; transform: translateY(10px); }
  20% { opacity: 1; transform: translateY(0); }
  80% { opacity: 1; transform: translateY(0); }
  100% { opacity: 0; transform: translateY(-10px); }
}

.error {
  max-width: 1400px;
  margin: 2rem auto;
  padding: 1rem 1.5rem;
  background: rgba(239, 68, 68, 0.1);
  border-left: 4px solid #ef4444;
  border-radius: 8px;
  color: #fca5a5;
  font-weight: 500;
}

.loading {
  max-width: 1400px;
  margin: 2rem auto;
  text-align: center;
  padding: 3rem;
  color: var(--text-secondary);
}

.loading::after {
  content: '';
  display: inline-block;
  width: 24px;
  height: 24px;
  border: 3px solid var(--border);
  border-top-color: var(--primary);
  border-radius: 50%;
  animation: spin 0.8s linear infinite;
  margin-left: 0.5rem;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}

.empty-state {
  text-align: center;
  padding: 4rem 2rem;
  color: var(--text-secondary);
}

.empty-state-icon {
  font-size: 3rem;
  margin-bottom: 1rem;
  opacity: 0.5;
}

@media (max-width: 768px) {
  body {
    padding: 1rem 0.5rem;
  }
  
  h2 {
    font-size: 1.5rem;
  }
  
  .stats {
    width: 100%;
  }
  
  th, td {
    padding: 0.75rem 0.5rem;
    font-size: 0.813rem;
  }
}
</style>
</head>
<body>
<div class="header">
  <h2>Devices Overview</h2>
  <div class="stats">
    <div class="stat-item" id="totalStat" onclick="filterDevices('all')">
      <span class="stat-label">Total</span>
      <span class="stat-value" id="totalCount">‚Äî</span>
    </div>
    <div class="stat-item" id="presentStat" onclick="filterDevices('present')">
      <span class="stat-label">Present</span>
      <span class="stat-value" id="presentCount">‚Äî</span>
    </div>
  </div>
</div>

<div class="search-container">
  <div class="search-wrapper">
    <span class="search-icon">üîç</span>
    <input 
      type="text" 
      id="searchInput" 
      placeholder="Search by MAC address or name..."
      autocomplete="off"
    >
    <button class="clear-search" id="clearSearch" onclick="clearSearch()">‚úï</button>
  </div>
</div>

<div class="container">
  <div class="scroll-hint" id="scrollHint">
    <span>Scroll to see more</span>
    <span class="scroll-arrow">‚Üí</span>
  </div>
  <div class="table-wrapper" id="tableWrapper">
    <table id="devTable">
      <thead>
        <tr>
          <th>Fingerprint</th>
          <th>Addresses</th>
          <th>Best RSSI</th>
          <th>Status</th>
          <th>Names</th>
          <th>Tags</th>
          <th>Activity</th>
          <th>Presence Details</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</div>

<script>
const url = 'bluelog.json';
let currentFilter = 'all';
let allDevices = [];

function copyToClipboard(text, event) {
  event.stopPropagation();
  
  if (navigator.clipboard && navigator.clipboard.writeText) {
    navigator.clipboard.writeText(text).then(() => {
      showCopyTooltip(event.clientX, event.clientY, 'Copied!');
    }).catch(err => {
      fallbackCopy(text, event);
    });
  } else {
    fallbackCopy(text, event);
  }
}

function fallbackCopy(text, event) {
  const textArea = document.createElement('textarea');
  textArea.value = text;
  textArea.style.position = 'fixed';
  textArea.style.left = '-9999px';
  textArea.style.top = '-9999px';
  document.body.appendChild(textArea);
  textArea.focus();
  textArea.select();
  
  try {
    const successful = document.execCommand('copy');
    if (successful) {
      showCopyTooltip(event.clientX, event.clientY, 'Copied!');
    } else {
      showCopyTooltip(event.clientX, event.clientY, 'Copy failed');
    }
  } catch (err) {
    console.error('Fallback copy failed:', err);
    showCopyTooltip(event.clientX, event.clientY, 'Copy failed');
  }
  
  document.body.removeChild(textArea);
}

function showCopyTooltip(x, y, message) {
  const tooltip = document.createElement('div');
  tooltip.className = 'copy-tooltip';
  tooltip.textContent = message;
  tooltip.style.left = x + 'px';
  tooltip.style.top = (y - 40) + 'px';
  
  document.body.appendChild(tooltip);
  
  setTimeout(() => {
    tooltip.remove();
  }, 1500);
}

function formatDuration(seconds) {
  if (!seconds) return '0s';
  const hours = Math.floor(seconds / 3600);
  const minutes = Math.floor((seconds % 3600) / 60);
  const secs = Math.floor(seconds % 60);
  
  const parts = [];
  if (hours > 0) parts.push(`${hours}h`);
  if (minutes > 0) parts.push(`${minutes}m`);
  if (secs > 0 || parts.length === 0) parts.push(`${secs}s`);
  
  return parts.join(' ');
}

function formatTimestamp(ts) {
  if (!ts) return '‚Äî';
  const date = new Date(ts * 1000);
  return date.toLocaleString();
}

function formatValue(v) {
  if (v === null || v === undefined) return '<span class="mono">null</span>';
  if (Array.isArray(v)) {
    return v.length ? v.map(item => 
      `<span class="badge" onclick="copyToClipboard('${escapeHtml(item)}', event)" title="Click to copy">${item}</span>`
    ).join('') : '‚Äî';
  }
  return v;
}

function escapeHtml(text) {
  const map = {
    '&': '&amp;',
    '<': '&lt;',
    '>': '&gt;',
    '"': '&quot;',
    "'": '&#039;'
  };
  return text.replace(/[&<>"']/g, m => map[m]);
}

function cell(v, className = '') {
  return `<td${className ? ` class="${className}"` : ''}>${formatValue(v)}</td>`;
}

function addressCell(addresses) {
  if (!Array.isArray(addresses) || addresses.length === 0) {
    return '<td class="mono">‚Äî</td>';
  }
  
  if (addresses.length === 1) {
    return `<td><span class="copyable-address" onclick="copyToClipboard('${escapeHtml(addresses[0])}', event)" title="Click to copy">${addresses[0]}</span></t
d>`;
  }
  
  const addressList = addresses.map(addr => 
    `<div class="address-item" onclick="copyToClipboard('${escapeHtml(addr)}', event)" title="Click to copy">${addr}</div>`
  ).join('');
  
  return `<td>
    <div class="collapsible-content collapsed" onclick="toggleCollapsible(event)">
      <div class="address-preview">
        <span class="copyable-address" onclick="copyToClipboard('${escapeHtml(addresses[0])}', event)" title="Click to copy">${addresses[0]}</span>
        <span class="expand-button">${addresses.length} total</span>
      </div>
      <div class="address-list">
        ${addressList}
      </div>
    </div>
  </td>`;
}

function presentCell(present) {
  const className = present ? 'present-true' : 'present-false';
  const text = present ? 'Present' : 'Absent';
  return `<td><span class="present-indicator ${className}">${text}</span></td>`;
}

function activityCell(dev) {
  return `<td>
    <div style="display: flex; flex-direction: column; gap: 0.25rem; font-size: 0.813rem;">
      <div><span style="color: var(--text-secondary);">Enter:</span> <span style="color: var(--text-primary); font-weight: 600;">${dev.enter_count || 0}</span
></div>
      <div><span style="color: var(--text-secondary);">Leave:</span> <span style="color: var(--text-primary); font-weight: 600;">${dev.leave_count || 0}</span
></div>
      <div><span style="color: var(--text-secondary);">Reenter:</span> <span style="color: var(--text-primary); font-weight: 600;">${dev.reenter_count || 0}</
span></div>
    </div>
  </td>`;
}

function presenceDetailsCell(dev) {
  const presenceByDay = dev.presence_by_day || {};
  const dayCount = Object.keys(presenceByDay).length;
  
  let daysList = '';
  if (dayCount > 0) {
    const sortedDays = Object.entries(presenceByDay)
      .sort((a, b) => b[0].localeCompare(a[0]))
      .map(([date, seconds]) => 
        `<div class="day-item">
          <span class="day-date">${date}</span>
          <span class="day-duration">${formatDuration(seconds)}</span>
        </div>`
      ).join('');
    
    daysList = `<div class="presence-by-day">${sortedDays}</div>`;
  }
  
  const hasDetails = dev.last_enter || dev.last_left || dev.last_seen_ts || dayCount > 0;
  
  if (!hasDetails) {
    return '<td class="mono">‚Äî</td>';
  }
  
  return `<td>
    <div class="collapsible-content collapsed" onclick="toggleCollapsible(event)">
      <div class="address-preview">
        <span class="expand-button">${dayCount > 0 ? `${dayCount} days` : 'Details'}</span>
      </div>
      <div class="presence-details">
        <div class="info-grid">
          ${dev.last_enter ? `<span class="info-label">Last Enter:</span><span class="info-value">${dev.last_enter}</span>` : ''}
          ${dev.last_left ? `<span class="info-label">Last Left:</span><span class="info-value">${dev.last_left}</span>` : ''}
          ${dev.last_seen_ts ? `<span class="info-label">Last Seen:</span><span class="info-value">${formatTimestamp(dev.last_seen_ts)}</span>` : ''}
        </div>
        ${daysList}
      </div>
    </div>
  </td>`;
}

function row(dev) {
  const presentClass = dev.present ? 'device-present' : 'device-absent';
  const searchData = JSON.stringify({
    addresses: dev.addresses || [],
    names: dev.names_seen || []
  });
  
  return `<tr class="${presentClass}" data-search='${escapeHtml(searchData)}'>
    ${cell(dev.fp, 'mono')}
    ${addressCell(dev.addresses)}
    ${cell(dev.best_rssi)}
    ${presentCell(dev.present)}
    ${cell(dev.names_seen)}
    ${cell(dev.tags)}
    ${activityCell(dev)}
    ${presenceDetailsCell(dev)}
  </tr>`;
}

function toggleCollapsible(event) {
  if (event.target.classList.contains('copyable-address') || 
      event.target.classList.contains('address-item')) {
    return;
  }
  
  event.stopPropagation();
  const content = event.currentTarget;
  content.classList.toggle('collapsed');
  content.classList.toggle('expanded');
}

function updateStats(devices) {
  const total = devices.length;
  const present = devices.filter(d => d.present).length;
  document.getElementById('totalCount').textContent = total;
  document.getElementById('presentCount').textContent = present;
}

function filterDevices(filter) {
  currentFilter = filter;
  const searchValue = document.getElementById('searchInput').value;
  applyFilters(searchValue);
  
  const totalStat = document.getElementById('totalStat');
  const presentStat = document.getElementById('presentStat');
  
  totalStat.classList.remove('active');
  presentStat.classList.remove('active');
  
  if (filter === 'all') {
    totalStat.classList.add('active');
  } else if (filter === 'present') {
    presentStat.classList.add('active');
  }
}

function applyFilters(searchValue) {
  const rows = document.querySelectorAll('#devTable tbody tr');
  const searchTerm = searchValue.toLowerCase().trim();
  
  rows.forEach(row => {
    let shouldShow = true;
    
    if (currentFilter === 'present' && !row.classList.contains('device-present')) {
      shouldShow = false;
    }
    
    if (searchTerm && shouldShow) {
      const searchData = JSON.parse(row.getAttribute('data-search') || '{"addresses":[],"names":[]}');
      const addresses = searchData.addresses || [];
      const names = searchData.names || [];
      
      const matchesAddress = addresses.some(addr => 
        addr.toLowerCase().includes(searchTerm)
      );
      const matchesName = names.some(name => 
        name.toLowerCase().includes(searchTerm)
      );
      
      if (!matchesAddress && !matchesName) {
        shouldShow = false;
      } else {
        row.classList.add('highlight');
      }
    } else {
      row.classList.remove('highlight');
    }
    
    if (shouldShow) {
      row.classList.remove('hidden');
    } else {
      row.classList.add('hidden');
    }
  });
}

function handleSearch() {
  const searchInput = document.getElementById('searchInput');
  const clearButton = document.getElementById('clearSearch');
  const searchValue = searchInput.value;
  
  if (searchValue) {
    clearButton.classList.add('visible');
  } else {
    clearButton.classList.remove('visible');
  }
  
  applyFilters(searchValue);
}

function clearSearch() {
  const searchInput = document.getElementById('searchInput');
  const clearButton = document.getElementById('clearSearch');
  
  searchInput.value = '';
  clearButton.classList.remove('visible');
  applyFilters('');
  searchInput.focus();
}

const tableWrapper = document.getElementById('tableWrapper');
const scrollHint = document.getElementById('scrollHint');
let isDown = false;
let startX;
let scrollLeft;

tableWrapper.addEventListener('mousedown', (e) => {
  if (e.target.closest('.collapsible-content') || 
      e.target.closest('.copyable-address') ||
      e.target.closest('.address-item') ||
      e.target.closest('.badge')) return;
  
  isDown = true;
  startX = e.pageX - tableWrapper.offsetLeft;
  scrollLeft = tableWrapper.scrollLeft;
});

tableWrapper.addEventListener('mouseleave', () => {
  isDown = false;
});

tableWrapper.addEventListener('mouseup', () => {
  isDown = false;
});

tableWrapper.addEventListener('mousemove', (e) => {
  if (!isDown) return;
  e.preventDefault();
  const x = e.pageX - tableWrapper.offsetLeft;
  const walk = (x - startX) * 2;
  tableWrapper.scrollLeft = scrollLeft - walk;
});

tableWrapper.addEventListener('scroll', () => {
  const isScrolledToEnd = tableWrapper.scrollLeft + tableWrapper.clientWidth >= tableWrapper.scrollWidth - 10;
  const isScrollable = tableWrapper.scrollWidth > tableWrapper.clientWidth;
  
  if (!isScrollable || isScrolledToEnd || tableWrapper.scrollLeft > 50) {
    scrollHint.classList.add('hidden');
  } else {
    scrollHint.classList.remove('hidden');
  }
});

document.getElementById('searchInput').addEventListener('input', handleSearch);

document.body.insertAdjacentHTML('beforeend', '<div class="loading">Loading devices</div>');

fetch(url)
  .then(r => r.ok ? r.json() : Promise.reject(`Failed to load data (${r.status})`))
  .then(d => {
    document.querySelector('.loading')?.remove();
    const tbody = document.querySelector('#devTable tbody');
    const devices = Object.values(d.devices || {});
    allDevices = devices;
    
    if (devices.length === 0) {
      tbody.innerHTML = '<tr><td colspan="8" class="empty-state"><div class="empty-state-icon">üì±</div><div>No devices found</div></td></tr>';
      scrollHint.classList.add('hidden');
      return;
    }
    
    devices.forEach(dev => {
      tbody.insertAdjacentHTML('beforeend', row(dev));
    });
    
    updateStats(devices);
    document.getElementById('totalStat').classList.add('active');
    
    setTimeout(() => {
      const isScrollable = tableWrapper.scrollWidth > tableWrapper.clientWidth;
      if (!isScrollable) {
        scrollHint.classList.add('hidden');
      }
    }, 100);
  })
  .catch(e => {
    document.querySelector('.loading')?.remove();
    document.body.insertAdjacentHTML('beforeend', 
      `<div class="error">‚ö†Ô∏è Error: ${e}</div>`);
    scrollHint.classList.add('hidden');
  });
</script>
</body>
</html>
